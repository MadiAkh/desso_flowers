{% extends "base.html" %}
{% load static %}

{% block title %}Каталог — DÉSSO FLOWERS{% endblock %}

{# подключим свой css, но сохраним базовые стилі #}
{% block extra_css %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'flowers_catalog_page/css/flowers_catalog_page.css' %}">
{% endblock %}


{% block hero %}
<section class="hero hero--catalog" id="catalogHero">
  <div class="slider" id="catalogHeroSlider">

    {% for slide in catalog_slides %}
      <section class="slide">
        <video autoplay muted playsinline loop
              {% if slide.poster %}poster="{{ slide.poster.url }}"{% endif %}>
          <source src="{{ slide.video.url }}" type="video/mp4">
        </video>

        <div class="gradient"></div>
        <div class="caption">
          {% if slide.kicker %}
            <div class="kicker">{{ slide.kicker }}</div>
          {% endif %}

          <h1 class="title">{{ slide.title }}</h1>

          {% if slide.subtitle %}
            <p class="subtitle">{{ slide.subtitle }}</p>
          {% endif %}

          {% if slide.cta_text %}
            <a href="{{ slide.cta_link }}" class="cta">
              {{ slide.cta_text }}
            </a>
          {% endif %}
        </div>
      </section>
    {% endfor %}

  </div>

  <div class="nav-zones">
    <button id="catalogHeroPrev"></button>
    <button id="catalogHeroNext"></button>
  </div>

  <div class="dots" id="catalogHeroDots"></div>
</section>
{% endblock hero %}

{% block content %}

<section class="catalog" id="catalog">
  <div class="catalog-header container">
    <div class="catalog-tabs">
        {# Вкладка "Все букеты" #}
        <button class="catalog-tab is-active" data-target="tab-all" type="button">
            Все букеты
            {% if products_all %}<span class="catalog-tab-count">({{ products_all|length }})</span>{% endif %}
        </button>

        {# Коллекции #}
        {% for collection in collections %}
            <button class="catalog-tab" data-target="tab-{{ collection.id }}" type="button">
                {{ collection.name }}
                {% with count=collection.products.count %}
                    {% if count %}<span class="catalog-tab-count">({{ count }})</span>{% endif %}
                {% endwith %}
            </button>
        {% endfor %}
    </div>

    <button class="catalog-filter-toggle" type="button">ФИЛЬТР</button>
  </div>

  <div class="filter-aside" id="filterAside">
      <div class="filter-aside__overlay"></div>
      <div class="filter-aside__content">
          <div class="filter-aside__header">
              <h3>Фильтры</h3>
              <button class="filter-aside__close" id="filterClose">&times;</button>
          </div>
          <div class="filter-aside__body">
            <div class="filter-group">
                <h4 class="filter-group__title">Цена (₸)</h4>

                <div class="price-inputs">
                    <input type="number" 
                          id="priceMin" 
                          value="{{ min_price }}" 
                          readonly>
                    
                    <input type="number" 
                          id="priceMax" 
                          value="{{ max_price }}" 
                          readonly>
                </div>

                <div class="price-slider-container">
                    <div class="slider-track-bg"></div>
                    <div class="slider-track-fill" id="sliderTrackFill"></div>

                    <input type="range" id="rangeMin" 
                          min="{{ min_price }}" 
                          max="{{ max_price }}" 
                          value="{{ min_price }}" 
                          step="100">
                          
                    <input type="range" id="rangeMax" 
                          min="{{ min_price }}" 
                          max="{{ max_price }}" 
                          value="{{ max_price }}" 
                          step="100">
                </div>
            </div>
        </div>
          <div class="filter-aside__footer">
              <button class="btn-filter btn-filter--apply" id="filterApply">Применить</button>
              <button class="btn-filter btn-filter--reset" id="filterReset">Убрать фильтр</button>
              <button class="btn-filter btn-filter--cancel" id="filterCancel">Отменить</button>
          </div>
      </div>
  </div>

  <div class="catalog-tabs-content container">

    {# ===== ВКЛАДКА "ВСЕ БУКЕТЫ" ===== #}
    <div class="catalog-grid is-active" id="tab-all">
      {% for product in products_all|slice:":12" %}
        <article class="catalog-card {% if forloop.first %}catalog-card--large{% endif %}" 
             data-price="{{ product.price|stringformat:'d' }}">
          <a href="#" class="catalog-card-media">
            {% if product.media_type == "image" %}
              <img src="{{ product.file.url }}" alt="{{ product.name }}">
            {% else %}
              <video muted playsinline loop>
                <source src="{{ product.file.url }}" type="video/mp4">
              </video>
            {% endif %}

            <div class="card-actions">
              <button class="btn-action btn-wishlist" type="button" aria-label="В избранное">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l8.84-8.84 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
              </button>
              <button class="btn-action btn-cart" type="button" aria-label="В корзину">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>
              </button>
            </div>

            {% if not product.is_active %}
              <span class="catalog-card-badge catalog-card-badge--out">НЕТ В НАЛИЧИИ</span>
            {% elif product.is_new %}
              <span class="catalog-card-badge catalog-card-badge--new">NEW</span>
            {% endif %}
          </a>

          <div class="catalog-card-body">
            <div class="catalog-card-category">{{ product.description }}</div>
            <h3 class="catalog-card-title">{{ product.name }}</h3>
            <div class="catalog-card-footer">
              <span class="catalog-card-price">{{ product.price }} ₸</span>
              </div>
          </div>
        </article>
      {% empty %}
        <p class="catalog-empty">Товары пока не добавлены.</p>
      {% endfor %}

      {# если товаров больше 12 — тут потом можно прикрутить слайдер/«показать ещё» #}
      {% if products_all|length > 12 %}
        <button class="catalog-more" data-source="all" type="button">
          Показать ещё
        </button>
      {% endif %}
    </div>

    {# ===== ОТДЕЛЬНЫЕ ВКЛАДКИ ДЛЯ КАЖДОЙ КОЛЛЕКЦИИ ===== #}
    {% for collection in collections %}
      <div class="catalog-grid" id="tab-{{ collection.id }}">
        {% for product in collection.products.all %}
          <article class="catalog-card" data-price="{{ product.price|stringformat:'d' }}">
            <a href="#" class="catalog-card-media">
              {% if product.media_type == "image" %}
                <img src="{{ product.file.url }}" alt="{{ product.name }}">
              {% else %}
                <video muted playsinline loop>
                  <source src="{{ product.file.url }}" type="video/mp4">
                </video>
              {% endif %}
              
              {# ... тут ваши кнопки wishlist/cart ... #}

              {% if not product.is_active %}
                <span class="catalog-card-badge catalog-card-badge--out">НЕТ В НАЛИЧИИ</span>
              {% elif product.is_new %}
                <span class="catalog-card-badge catalog-card-badge--new">NEW</span>
              {% endif %}
            </a>

            <div class="catalog-card-body">
                <div class="catalog-card-category">{{ product.description }}</div>
                <h3 class="catalog-card-title">{{ product.name }}</h3>
                <div class="catalog-card-footer">
                    <span class="catalog-card-price">{{ product.price }} ₸</span>
                </div>
            </div>
          </article>
        {% endfor %}
        
        {% if collection.products.count > 12 %}
          <button class="catalog-more" type="button">Показать ещё</button>
        {% endif %}
      </div>
    {% endfor %}

  </div>
</section>

{% endblock %}

{% block scripts %}
  {{ block.super }}
  <script async src="{% static 'base_page/js/hero.js' %}"></script>
  <script async src="{% static 'base_page/js/header.js' %}"></script>
  ...
  <script async src="{% static 'base_page/js/stories.js' %}"></script>
  <script async src="{% static 'flowers_catalog_page/js/flowers_catalog_page.js' %}"></script>
{% endblock %}
